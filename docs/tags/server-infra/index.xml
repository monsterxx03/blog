<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>server-infra on Shining Moon</title>
    <link>https://blog.monsterxx03.com/tags/server-infra/</link>
    <description>Recent content in server-infra on Shining Moon</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>monsterxx03</copyright>
    <lastBuildDate>Thu, 30 May 2019 18:48:23 +0800</lastBuildDate>
    
	<atom:link href="https://blog.monsterxx03.com/tags/server-infra/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Random Talk</title>
      <link>https://blog.monsterxx03.com/2019/05/30/random-talk/</link>
      <pubDate>Thu, 30 May 2019 18:48:23 +0800</pubDate>
      
      <guid>https://blog.monsterxx03.com/2019/05/30/random-talk/</guid>
      <description>Just some random complains and notes about server infra management. I think those are my motivations to move to kubernetes.
Won&amp;rsquo;t explain k8s or docker in detail, and how they solve those problems in this post.
Infrastructure level(on AWS) We use following services provided by AWS.
 Compute:  EC2 AutoScaling Group Lambda   network:  VPC (SDN network) DNS (route53) CDN (CloudFront)   Loadbalancer:  ELB (L4) NLB (L4, ELB successor, support static IP) ALB (L7)   Storage:  EBS (block storage) EFS (hosted NFS) RDS(MySQl/PostgreSQL &amp;hellip;) Redshift (data warehouse) DynamoDB (KV) S3 (object storage) Glacier (cheap archive storage)   Web Firewall (WAF) Monitor (CloudWatch) DMS (ETL) &amp;hellip;  For infra management, in early days, we just click, click, click&amp;hellip; or write some simple scripts to call AWS api.
With infra resources growing, management became complex, a concept called Infrastructure as Code rising.
AWS provides CloudFormation as orchestration tool, but we use terraform (for short: CloudFormation sucks, for long: Infrastructure as Code)
So far, not bad.(tweak those services internally is another story&amp;hellip; never belive work out of box)
Application level  configuration management (setup nginx, jenkins, redis, twemproxy, ElasticSearch or WTF..) CI/CD dependency management  They&amp;rsquo;re complicated, people developped bunch of tools to handle: puppet, chef, ansible, saltstack &amp;hellip;</description>
    </item>
    
    <item>
      <title>AWS Aurora DB</title>
      <link>https://blog.monsterxx03.com/2018/10/31/aws-aurora-db/</link>
      <pubDate>Wed, 31 Oct 2018 15:23:45 +0800</pubDate>
      
      <guid>https://blog.monsterxx03.com/2018/10/31/aws-aurora-db/</guid>
      <description>æœ€è¿‘åœ¨æŠŠéƒ¨åˆ†ç”¨ RDS çš„ MySQL è¿ç§»åˆ° aurora ä¸Šå», è¯»äº†ä¸‹ aurora çš„ paper, é¡ºä¾¿å’Œ RDS çš„æ¶æ„åšäº›å¯¹æ¯”. Paper notes å­˜å‚¨è®¡ç®—åˆ†ç¦» redo log ä¸‹æ¨åˆ°å­˜å‚¨å±‚ å‰¯æœ¬: 6 å‰¯æœ¬ 3 AZ(2 per az), å¤±å»ä¸€ä¸ª AZ + 1 additoinal node ä¸ä¼šä¸¢æ•°æ®(å¯è¯»ä¸å¯å†™). å¤±å»ä¸€ä¸ª AZ (æˆ–ä»»æ„2 node) ä¸å½±å“æ•°æ®å†™å…¥. 10GB ä¸€ä¸ª segment, æ¯ä¸ª segment 6 å‰¯æœ¬ä¸€ä¸ª PG (protection group), ä¸€ AZ ä¸¤å‰¯æœ¬. åœ¨ 10Gbps çš„ç½‘ç»œä¸Š, ä¿®å¤ä¸€ä¸ª 10GB çš„segment éœ€è¦ 10s. MySQL ä¸€ä¸ªåº”ç”¨å±‚çš„å†™ä¼šåœ¨åº•å±‚äº§ç”Ÿå¾ˆå¤šé¢å¤–çš„å†™æ“ä½œï¼Œä¼šå¸¦æ¥å†™æ”¾å¤§é—®é¢˜: redo log ç”¨æ¥ crash recovery, binlog ä¼šä¸Šä¼  s3 ç”¨äº point in time restore. åœ¨ aurora é‡Œï¼Œåª</description>
    </item>
    
    <item>
      <title>ä¸º service åˆ¶å®š SLO</title>
      <link>https://blog.monsterxx03.com/2018/10/15/%E4%B8%BA-service-%E5%88%B6%E5%AE%9A-slo/</link>
      <pubDate>Mon, 15 Oct 2018 11:31:05 +0800</pubDate>
      
      <guid>https://blog.monsterxx03.com/2018/10/15/%E4%B8%BA-service-%E5%88%B6%E5%AE%9A-slo/</guid>
      <description>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨äº‘æœåŠ¡çš„æ—¶å€™, æœåŠ¡æä¾›å•†ä¼šæä¾› SLA(Service Level Aggrement),ä½œä¸ºä»–ä»¬æä¾›çš„æœåŠ¡è´¨é‡çš„æ ‡å‡†(å¸¸è¯´çš„å‡ ä¸ª9),è¾¾ä¸åˆ°ä¼šè¿›è¡Œèµ”å¿. æ¯”å¦‚ AWS çš„è®¡ç®—ç±»æœåŠ¡: https://aws.amazon.com/compute/sla/ . å¯¹å…¬å¸è‡ªå·± host çš„ service, æˆ‘ä»¬å†…éƒ¨ä¹Ÿéœ€è¦ä¸€äº›æŠ€æœ¯æŒ‡æ ‡æ¥ track æˆ‘ä»¬ä¸ºå®¢æˆ·æä¾›çš„æœåŠ¡è´¨é‡å¦‚ä½•, è¿™ä¸ªå«åš SLO(Service Level Objective). ä¹Ÿå¯ä»¥æŠŠä»–å½“æˆä¸€ä¸ªå¯¹å†…çš„,æ²¡æœ‰èµ”å¿åè®®çš„SLA. å®šä¹‰æŒ‡æ ‡ æˆ‘ä¸»è¦ track ä¸¤ä¸ªæŒ‡æ ‡: Availability (æœåŠ¡çš„å¯ç”¨æ€§) Quality (æœåŠ¡è´¨é‡) Availability çš„å®šä¹‰, ä»¥å‰ç”¨ç®€å•çš„ service uptime æ¥å®šä¹‰, åœ¨é›†ç¾¤å¤–éƒ¨ç”¨ä¸€</description>
    </item>
    
    <item>
      <title>AWS lambda çš„ä¸€äº›åº”ç”¨åœºæ™¯</title>
      <link>https://blog.monsterxx03.com/2018/03/23/aws-lambda-%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/</link>
      <pubDate>Fri, 23 Mar 2018 17:40:54 +0800</pubDate>
      
      <guid>https://blog.monsterxx03.com/2018/03/23/aws-lambda-%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF/</guid>
      <description>è¿™å‡ å¹´å¹ serverless çš„æ¯”è¾ƒå¤š, åœ¨å…¬å¸å†…éƒ¨ä¹Ÿç”¨ lambda , è®°å½•ä¸€ä¸‹, è¿™ä¸œè¥¿æŒºæœ‰ç”¨, ä½†è¿œä¸åˆ°ä¸‡èƒ½, åœºæ™¯æ¯”è¾ƒæœ‰é™. lambda çš„ä»£ç çš„éƒ¨ç½²ç”¨çš„ serverless æ¡†æ¶, æœ¬èº«æ”¯æŒå¤šç§ cloud å¹³å°, æˆ‘ä»¬å°±åªåœ¨ aws lambda ä¸Šäº†. æˆ‘åŸºæœ¬ä¸Šå°±æŠŠ lambda å½“æˆ trigger å’Œ web hook ç”¨. å’Œ auto scaling group ä¸€èµ·ç”¨ çº¿ä¸Šæ‰€æœ‰åˆ†ç»„çš„æœºå™¨éƒ½æ˜¯ç”¨ auto scaling group ç®¡ç†çš„, åªä¸è¿‡ stateless çš„ server å¼€äº†è‡ªåŠ¨ä¼¸ç¼©, å¸¦çŠ¶æ€çš„ (ElasticSearch cluster, redis cache cluster) åªç”¨æ¥ç»´æŠ¤å›ºå®š size. åœ¨å¾€ä¸€ä¸ª group é‡ŒåŠ  server çš„æ—¶å€™, è¦åšçš„äº‹æƒ…æŒºå¤šçš„, ç»™æ–° server æ·»åŠ ç»„å†…ç¼–å· tag, æ·»åŠ å†…ç½‘åŸŸå, provision, éƒ¨ç½²æœ€æ–°ä»£ç . è¿™äº›äº‹éƒ½ç”¨</description>
    </item>
    
    <item>
      <title>DynamoDB</title>
      <link>https://blog.monsterxx03.com/2017/12/15/dynamodb/</link>
      <pubDate>Fri, 15 Dec 2017 22:24:36 +0800</pubDate>
      
      <guid>https://blog.monsterxx03.com/2017/12/15/dynamodb/</guid>
      <description>DynamoDB æ˜¯ AWS çš„æ‰˜ç®¡ NoSQL æ•°æ®åº“ï¼Œå¯ä»¥å½“ä½œç®€å•çš„ KV æ•°æ®åº“ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºæ–‡æ¡£æ•°æ®åº“ä½¿ç”¨. Data model ç»„ç»‡æ•°æ®çš„å•ä½æ˜¯ table, æ¯å¼  table å¿…é¡»è®¾ç½® primary key, å¯ä»¥è®¾ç½®å¯é€‰çš„ sort key æ¥åšç´¢å¼•. æ¯æ¡æ•°æ®è®°ä½œä¸€ä¸ª item, æ¯ä¸ª item å«æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª attribute, å…¶ä¸­å¿…é¡»åŒ…æ‹¬ primary key. attribute å¯¹åº”çš„ value æ”¯æŒä»¥ä¸‹å‡ ç§ç±»å‹: Number, ç”±äº DynamoDB çš„ä¼ è¾“åè®®æ˜¯ http + json, ä¸ºäº†è·¨è¯­è¨€çš„å…¼å®¹æ€§, number ä¸€å¾‹ä¼šè¢«è½¬æˆ string ä¼ è¾“. Binary, ç”¨æ¥è¡¨ç¤ºä»»æ„çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œä¼šç”¨ base64 encode åä¼ è¾“. Boolean, true or false Null Document ç±»å‹åŒ…å« List å’Œ Map, å¯ä»¥äº’ç›¸åµŒå¥—. List, ä¸ªæ•°æ— é™åˆ¶, æ€»å¤§å°</description>
    </item>
    
    <item>
      <title>Handle outage</title>
      <link>https://blog.monsterxx03.com/2017/12/10/handle-outage/</link>
      <pubDate>Sun, 10 Dec 2017 11:13:53 +0800</pubDate>
      
      <guid>https://blog.monsterxx03.com/2017/12/10/handle-outage/</guid>
      <description>A few weeks ago, production environment came to an outage, solve it cost me 8 hours (from 3am to 11am) although total down time is not long, really a bad expenrience. Finally, impact was mitigated, and I&amp;rsquo;m working on a long term solution. I learned some important things from this accident.
The outage I received alarms about live performance issue at 3am, first is server latency increaing, soon some service&amp;rsquo;s health check failed due to high load.
I did following:
 Check monitor Identify the problem is caused by KV system  Okay, problem is here, I know the problem is KV system&amp;rsquo;s performance issue. But I can&amp;rsquo;t figure out the root case right now, I need a temporary solution. Straightward way is redirect traffic to slave instance. But I know it won&amp;rsquo;t work (actually it is true), I come to similar issue before, did a fix for it, but seems it doesn&amp;rsquo;t work.
The real down time was not long, performance recovered to some degree soon, but latency was still high, not normal. I monitored it for long time, and tried to find out the root case until morning. Since traffic was growing when peak hour coming, performance became problem again.</description>
    </item>
    
    <item>
      <title>Python Web åº”ç”¨æ€§èƒ½è°ƒä¼˜</title>
      <link>https://blog.monsterxx03.com/2017/07/01/python-web-%E5%BA%94%E7%94%A8%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/</link>
      <pubDate>Sat, 01 Jul 2017 23:38:24 +0800</pubDate>
      
      <guid>https://blog.monsterxx03.com/2017/07/01/python-web-%E5%BA%94%E7%94%A8%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/</guid>
      <description>Python web åº”ç”¨æ€§èƒ½è°ƒä¼˜ ä¸ºäº†å¿«é€Ÿä¸Šçº¿ï¼Œæ—©æœŸå¾ˆå¤šä»£ç åŸºæœ¬æ˜¯æ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥ï¼Œè¿™æ ·å°±ç•™ä¸‹äº†å¾ˆå¤šéšæ‚£ï¼Œæ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆç†æƒ³ï¼Œpython å› ä¸º GIL çš„åŸå› ï¼Œåœ¨æ€§èƒ½ä¸Šæœ‰å¤©ç„¶åŠ£åŠ¿ï¼Œå³ä½¿ç”¨äº† gevent/eventlet è¿™ç§åç¨‹æ–¹æ¡ˆï¼Œä¹Ÿå¾ˆå®¹æ˜“å› ä¸ºè€—æ—¶çš„ CPU æ“ä½œé˜»å¡ä½æ•´ä¸ªè¿›ç¨‹ã€‚å‰é˜µå­å¯¹åŸºç¡€ä»£ç åšäº†äº›é‡æ„ï¼Œæ•ˆæœæ˜¾è‘—ï¼Œè®°å½•ä¸€äº›ã€‚ è®¾å®šç›®æ ‡: æ€§èƒ½æé«˜äº†ï¼Œæœ€ç›´æ¥çš„æ•ˆæœå½“ç„¶æ˜¯èƒ½ç”¨æ›´å°‘çš„æœºå™¨å¤„ç†ç›¸åŒæµé‡ï¼Œç›®æ ‡æ˜¯å…³é—­ 20% çš„ stateless webserver. å°½é‡åœ¨æ¡†æ¶ä»£ç ä¸Šåšæ”¹åŠ¨ï¼Œä¸åŠ¨ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚ ä½é£é™© (å†</description>
    </item>
    
    <item>
      <title>Build deb repository with fpm , aptly and s3</title>
      <link>https://blog.monsterxx03.com/2017/06/23/build-deb-repository-with-fpm-aptly-and-s3/</link>
      <pubDate>Fri, 23 Jun 2017 09:40:58 +0000</pubDate>
      
      <guid>https://blog.monsterxx03.com/2017/06/23/build-deb-repository-with-fpm-aptly-and-s3/</guid>
      <description>Iâ€™m lazy, I donâ€™t want to be deb/rpm expert, I donâ€™t want to maintain repo server. I want as less maintenance effort as possible. ğŸ™‚
Combine tools fpm, aptly with aws s3, we can do it.
Use fpm to convert python package to deb fpm can transform python/gem/npm/dir/â€¦ to deb/rpm/solaris/â€¦ packages
Example:
fpm -s python -t deb -m xyj.asmy@gmail.com --verbose -v 0.10.1 --python-pip /usr/local/pip Flask  It will transform Flask 0.10.1 package to deb. Output package will be python-flask_0.10.1_all.deb
Notes:
 If python packages rely on some c libs like MySQLdb (libmysqlclient-dev), you need to install them on the machine to build deb binary. By default fpm use easy_install to build packages, some packages like httplib2 have permission bug with easy_install, so I use pip By default, msgpack-python will be convert to python-msgpack-python, I donâ€™t like it, so add -n python-msgpack to normalize the package name. Some packageâ€™s dependenciesâ€™ version number is not valid(eg: celery 3.1.25 deps pytz &amp;gt;= dev), so I replace the dependencies with --python-disable-dependency pytz -d &#39;pytz &amp;gt;= 2016.7&#39; fpm will not dowload packageâ€™s dependency automatically, you need to do it by your self  Use aptly to setup deb repository aptly can help build a self host deb repository and publish it on s3.</description>
    </item>
    
    <item>
      <title>Infrastructure as Code</title>
      <link>https://blog.monsterxx03.com/2017/04/21/infrastructure-as-code/</link>
      <pubDate>Fri, 21 Apr 2017 16:25:07 +0000</pubDate>
      
      <guid>https://blog.monsterxx03.com/2017/04/21/infrastructure-as-code/</guid>
      <description>Create virtual resource on AWS is very convenient, but how to manage them will be a problem when your size grow.
You will come to:
 How to explain the detail online settings for your colleagues (like: how our prod vpc is setup?whatâ€™s the DHCP option set?), navigate around AWS console is okay, but not convenient. Who did what to which resource at when? AWS have a service called Config, can be used to track this change, but if you want to make things as clear as viewing git log, still a lot of works to do.  Ideally, we should manage AWS resources like code, all changes kept in VCS, so called Infrastructure as Code.
Iâ€™ve tried three ways to do it:
 ansible CloudFormation terraform  In this article, I&amp;rsquo;ll compare them, however, the conclusion is to use terraform ğŸ™‚
Ansible Provision tools, like ansible/chef/puppet, all can be used to create aws resources, but they have some common problems:
 Hard to track changes after bootstrap. No confident what it will do to existing resources.  For example, I define a security group in ansibble:
ec2_group: name: &amp;quot;web&amp;quot; description: &amp;quot;security group in web&amp;quot; vpc_id: &amp;quot;vpc-xxx&amp;quot; region: &amp;quot;us-east-1&amp;quot; rules: - proto: tcp from_port: 80 to_port: 80 cidr_ip: 0.</description>
    </item>
    
    <item>
      <title>Migrate to encrypted RDS</title>
      <link>https://blog.monsterxx03.com/2016/10/28/migrate-to-encrypted-rds/</link>
      <pubDate>Fri, 28 Oct 2016 16:17:30 +0000</pubDate>
      
      <guid>https://blog.monsterxx03.com/2016/10/28/migrate-to-encrypted-rds/</guid>
      <description>&lt;p&gt;æœ€è¿‘å…¬å¸åœ¨åš HIPAA Compliance ç›¸å…³çš„äº‹æƒ…ï¼Œå…¶ä¸­è¦æ±‚ä¹‹ä¸€æ˜¯æ‰€æœ‰dbéœ€è¦å¼€å¯encryption.&lt;/p&gt;
&lt;p&gt;æ¯”è¾ƒéº»çƒ¦çš„æ˜¯rds çš„encryption åªèƒ½åœ¨åˆ›å»ºçš„æ—¶å€™è®¾å®šï¼Œæ— æ³•ä¹‹åä¿®æ”¹, æ‰€ä»¥å¿…é¡»å¯¹çº¿ä¸Šçš„db åšä¸€æ¬¡ migration.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>MySQL innodb buffer pool</title>
      <link>https://blog.monsterxx03.com/2016/07/16/mysql-innodb-buffer-pool/</link>
      <pubDate>Sat, 16 Jul 2016 16:07:14 +0800</pubDate>
      
      <guid>https://blog.monsterxx03.com/2016/07/16/mysql-innodb-buffer-pool/</guid>
      <description>&lt;p&gt;æœ€è¿‘åœ¨å¯¹å…¬å¸çš„ MySQL æœåŠ¡å™¨åšæ€§èƒ½ä¼˜åŒ–, ä¸€ç›´å¯¹ innodb çš„å†…å­˜ä½¿ç”¨æ–¹å¼ä¸æ˜¯å¾ˆæ¸…æ¥š, ä¹˜è¿™æœºä¼šåšç‚¹æ€»ç»“.&lt;/p&gt;
&lt;p&gt;åœ¨é…ç½® MySQL çš„æ—¶å€™, ä¸€èˆ¬éƒ½ä¼šéœ€è¦è®¾ç½® &lt;em&gt;innodb_buffer_pool_size&lt;/em&gt;, åœ¨å°† MySQL è®¾ç½®åœ¨å•ç‹¬çš„æœåŠ¡å™¨ä¸Šæ—¶, ä¸€èˆ¬ä¼šè®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„80%.&lt;/p&gt;
&lt;p&gt;ä¹‹å‰ä¸€ç›´ç–‘æƒ‘ MySQL æ˜¯æ€ä¹ˆç¼“å­˜æ•°æ®çš„(ä¸æ˜¯æŒ‡query cache), ç›´è§‰åº”è¯¥æ˜¯LRU, ä½†å¦‚æœ query ä¸€ä¸‹ä»ç£ç›˜ä¸Šè¯»å–å¤§é‡çš„æ•°æ®çš„è¯(å…¨è¡¨æ‰«ææˆ–æ˜¯ mysqldump), æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±ä¼šæŠŠçƒ­æ•°æ®ç»™è¸¢å‡ºå»?&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>